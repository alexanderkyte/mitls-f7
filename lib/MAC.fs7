module MAC

open Bytes
open Algorithms
open TLSInfo

/// a refined, ideal interface for indexed MACs
/// this file is loosely synchronized with cma/mac2.fs7

//CF 12-02: we need to support agility here, 
//          guaranteeing that ki has a MAC, and 
//          providing exact lengths for keys and tags.


private type (;ki:KeyInfo) key = {k:(x:bytes{Length(x) = MacKeySize(CipherSuites.CipherSuiteMACAlg(ki.sinfo.cipher_suite))})}
type text = bytes
type tag = bytes
predicate val Msg: KeyInfo * text -> bool

val Mac:    ki:KeyInfo -> k:(;ki) key -> t:text{Msg(ki,t)} -> t:tag{Length(t) = MacKeySize(CipherSuites.CipherSuiteMACAlg(ki.sinfo.cipher_suite))}
val Verify: ki:KeyInfo -> k:(;ki) key -> t:text -> tag -> 
  v:bool{ (v=true /\ Auth(ki)) => Msg(ki,t) }

val GEN:    ki:KeyInfo -> (;ki) key
val LEAK:   ki:KeyInfo{not(Auth(ki))} -> (;ki)key -> bytes
val COERCE: ki:KeyInfo{not(Auth(ki))} -> x:bytes{Length(x) = MacKeySize(CipherSuites.CipherSuiteMACAlg(ki.sinfo.cipher_suite))} -> (;ki)key
