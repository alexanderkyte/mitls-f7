#! /usr/bin/env python

# --------------------------------------------------------------------
import sys, os, time, xml.etree.ElementTree as etree

# --------------------------------------------------------------------
MSBUILD = 'http://schemas.microsoft.com/developer/msbuild/2003'

MKHEADER = '''\
include ../Makefile.config

lib7     = ../../../lib/fs7-interfaces/
libperv  = $(lib7)pervasives.fs7 $(lib7)tuples.fs7
lperv    = -pervasives $(lib7)pervasives.fs7 -tuples $(lib7)tuples.fs7
libfs7   = $(lib7)pi.fs7 $(lib7)formulas.fs7
f7flags += -nokindcheck $(lperv) $(libfs7)

.PHONY: default clean

default: TLS.tc7

clean:
\trm -f *.tc7
'''

# --------------------------------------------------------------------
def _main():
    if len(sys.argv)-1 != 1:
        print >>sys.stderr, 'Usage: %s [fsproj]' % (os.path.basename(sys.argv[0]))
        exit(1)

    with open(sys.argv[1], 'r') as stream:
        doc = etree.parse(stream)

    files = doc.findall('.//{0}ItemGroup/*'.format('{%s}' % (MSBUILD,)))
    files = [x.get('Include') for x in files if x.get('Include') is not None]
    files = [x for x in files if os.path.splitext(x)[1] == '.fs7']
    files = [os.path.splitext(x)[0] for x in files]

    print "# -*- Makefile -*-"
    print "# Automatically generated by: %s" % (' '.join(sys.argv),)
    print "# Generated on %s" % (time.ctime(),)
    print
    print MKHEADER
    print "# ----- BEGIN AUTO FS7 -----"
    for i in xrange(len(files)):
        name = files[i]
        deps = ['%s.fs7' % (x,) for x in files[:i]]
        print '%s.tc7: $(libperv) $(libfs7) %s %s.fs7 %s.fs' % (files[i], ' '.join(deps), name, name)
        print '\t$(f7) $(f7flags) -scripts %s %s %s.fs7 %s.fs' % (name, ' '.join(deps), name, name)
        print '\t@touch $@'
        print
    print "# ----- END AUTO FS7 -----"

# --------------------------------------------------------------------
if __name__ == '__main__':
    _main()
